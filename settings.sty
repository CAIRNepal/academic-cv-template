%%%%%%%%%%%%%%%
% Curriculum Vitae Template
% Academic CV Template
% CAIR-Nepal
% info@cair-nepal.org
%

\RequirePackage{silence}
\WarningsOff[longtable]
\WarningsOff[array]

\usepackage{ifxetex,ifluatex}
\newif\ifxetexorluatex
\ifxetex
  \xetexorluatextrue
\else
  \ifluatex
    \xetexorluatextrue
  \else
    \xetexorluatexfalse
  \fi
\fi

\RequirePackage{graphicx}
\RequirePackage[hyphens]{url}
\RequirePackage{babel}
\raggedright
% Allow flexible page breaking - sections can break across pages
\raggedbottom
% http://www.ipgp.fr/~moguilny/LaTeX/fontawesome5Icons.pdf
\RequirePackage[fixed]{fontawesome5}

\newcommand{\smallcaps}[1]{\textsc{\lowercase{#1}}}

\RequirePackage[a4paper,nohead,hmargin=2cm,vmargin=1.8cm]{geometry}
\RequirePackage{fancyhdr}
\RequirePackage{relsize}
\RequirePackage[dvipsnames,svgnames]{xcolor}
\RequirePackage{tikz}
\usetikzlibrary{shapes,shadows}

\RequirePackage{comment}
\RequirePackage{etoolbox}
% --- Prevent large blank spaces before section headers ---
\RequirePackage{needspace}
% Formal color scheme - dark gray/black for professional appearance
% line
\definecolor{SwishLineColour}{HTML}{2C3E50}
% icon - professional dark blue-gray
\definecolor{MarkerColour}{HTML}{34495E}

% If you're not a researcher nor an academic, you probably don't need biblatex; delete this line.
\RequirePackage[bibstyle=apa6,sorting=ymdnt,uniquename=init,defernumbers=true]{biblatex}
\RequirePackage{csquotes}
%% Added 17 Jan 2018 from https://tex.stackexchange.com/a/140641/226 and https://tex.stackexchange.com/a/46879/226
\DeclareSortingTemplate{ymdnt}{
  \sort{
    \field{presort}
  }
  \sort[final]{
    \field{sortkey}
  }
  \sort[direction=descending]{
    \field[strside=left,strwidth=4]{sortyear}
    \field[strside=left,strwidth=4]{year}
    \literal{9999}
  }
  \sort[direction=descending]{
    \field[padside=left,padwidth=2,padchar=0]{month}
    \literal{00}
  }
  \sort[direction=descending]{
    \field[padside=left,padwidth=2,padchar=0]{day}
    \literal{00}
  }
  \sort{
    \field{sortname}
    \field{author}
    \field{editor}
    \field{translator}
    \field{sorttitle}
    \field{title}
  }
  \sort{
    \field{sorttitle}
    \field{title}
  }
}

\RequirePackage{tikz}
\newcommand*\circled[1]{\tikz[baseline=(char.base)]{
   \node[shape=circle,text=white,fill=MarkerColour,font=\sffamily\scriptsize\bfseries,inner sep=1pt,text height=1.35ex,minimum width=1.5em,text centered] (char) {#1};}}
   
\newcounter{bibitem}
\AtBeginBibliography{\setcounter{bibitem}{1}}
\AtEveryBibitem{\makebox[2.5em][l]{\circled{\thebibitem}\stepcounter{bibitem}}}

% \renewcommand{\bibfont}{\small}
\setlength{\bibitemsep}{1.5ex}
\setlength{\bibhang}{2.5em}
\RequirePackage{xpatch}
\xpretofieldformat{doi}
  {\textcolor{MarkerColour}{\scriptsize\faLink}}
  {}{}
\xpretofieldformat{url}
  {\textcolor{MarkerColour}{\scriptsize\faLink}}
  {}{}
  % impact factor
% \xpretofieldformat{if}
%   {{#1}}
%   {}{}

\headerscale{1}
\setlength{\headerspace}{8pt}
\rubricfont{\Large\bfseries\sffamily}
\setlength{\rubricspace}{1pt}
\setlength{\rubricafterspace}{-8pt}
\setlength{\subrubricspace}{4pt}
\setlength{\subrubricbeforespace}{5pt}
% Rebuild rubric header drawing (unchanged)
\def\@@rubrichead#1{%
  \begin{tikzpicture}[baseline]%
    \fill[SwishLineColour] (0,0) rectangle (\@almosttextwidth,1.5pt);
    \node[
      font={\@rubricfont},
      inner sep=0pt,
      text ragged,
      anchor=south west,
      text depth=.5ex,
      text height=1.5ex,
      text=SwishLineColour
    ] at (0pt,3pt) {#1};
  \end{tikzpicture}%
  \vspace\rubricspace%
}

\subrubricfont{\large\bfseries\sffamily}
\subrubricalignment{l}

\newcommand{\makefield}[2]{\makebox[1.5em]{\color{MarkerColour}#1} #2\hspace{1.5em}}

\keyalignment{r}
\rubricalignment{l}
\renewcommand{\arraystretch}{1.25}
\urlstyle{tt}

% Set key width to 0 to remove indentation from entries
% Check if \keywidth is defined (from curve class)
% If not defined, define it as a length; otherwise set it
\@ifundefined{keywidth}{%
  \newlength{\keywidth}%
}{}%
\setlength{\keywidth}{0pt}

% Remove paragraph indentation globally
\setlength{\parindent}{0pt}

\newcommand{\prefixmarker}[1]{\def\@prefixmarker{#1}}
\def\@prefixmarker{}

\prefix{%
}

% --- THIS IS THE FIX ---
% Smarter section heading that avoids huge blank space
% Allow sections to break across pages - start on current page and continue on next
\renewcommand{\makerubrichead}[1]{%
  % Allow page breaks before section headers so sections can flow across pages
  \allowbreak
  % No forced page breaks - let LaTeX handle breaks naturally
  \@@rubrichead{#1}%
}

% Aliases for clearer naming - cvsection instead of rubric
% Allow page breaks within sections so content can flow across pages
\newenvironment{cvsection}[1]{%
  \allowbreak
  \begin{rubric}{#1}%
}{%
  \end{rubric}%
}
\newcommand{\makecvsection}[1]{\makerubric{#1}}
\newcommand{\makecvsectionhead}[1]{\makerubrichead{#1}}
\newcommand{\subcvsection}[1]{\subrubric{#1}}

\defbibheading{subbibliography}{\vskip\subrubricbeforespace{\@subrubricfont\hspace{3pt}#1}\par}

\defbibfilter{booksandchapters}{%
( type=book or type=incollection )
}

 

% Command to set the CV author's name for automatic bolding in publications
% Usage: \myname{LastName}{First\bibnamedelima Name}
% Use \bibnamedelima for spaces in the first name (e.g., "First\bibnamedelima Middle\bibnamedelima Name")
\newcommand{\myname}[2]{%
   \def\@mylastname{#1}%
   \def\@myfirstname{#2}%
}

% Automatically bold the author's name in bibliography entries
% This redefines how family names are formatted in citations
\renewcommand*{\mkbibnamefamily}[1]{%
  \ifboolexpr{ test {\ifdefstrequal{\namepartfamily}{\@mylastname}}
               and
               test {\ifdefstrequal{\namepartgiven}{\@myfirstname}}}
    {\textbf{#1}}%
    {#1}%
}

% Automatically bold the author's name in bibliography entries
% This redefines how given names are formatted in citations
\renewcommand*{\mkbibnamegiven}[1]{%
  \ifboolexpr{ test {\ifdefstrequal{\namepartfamily}{\@mylastname}}
               and
               test {\ifdefstrequal{\namepartgiven}{\@myfirstname}}}
    {\textbf{#1}}%
    {#1}%
}

\RequirePackage[colorlinks=true,linkcolor=MarkerColour,urlcolor=MarkerColour,citecolor=MarkerColour,filecolor=MarkerColour,breaklinks=true]{hyperref}

% ==================== Protect entry command from direct use ====================
% Save the original \entry and \entry* commands for internal use
\let\@entry\entry
% Check if \entry* exists and save it
\@ifundefined{entry*}{}{%
  \expandafter\let\expandafter\@entrystar\csname entry*\endcsname
}
% Temporarily allow \entry to work normally to test if this is causing the issue
% TODO: Re-enable protection once compilation works
% \renewcommand{\entry}{%
%   % Direct use of \entry is not allowed - use template commands instead
% }

% ==================== CV Entry Template Commands ====================
% Template commands for consistent formatting across all CV sections

% Define empty token for comparison
\def\@cv@empty{}

% Helper macro for empty argument checking (robust version)
% Uses \if\relax\detokenize pattern which works reliably in tabular contexts
% This prevents "Extra \or" errors in LaTeX 2025
\newcommand{\@cvifempty}[3]{%
  \if\relax\detokenize{#1}\relax #2\else #3\fi
}

% Research Interest Entry
% Usage: \researchinterest{interests}
% interests should be comma-separated
\newcommand{\researchinterest}[1]{%
  \@entry*[]%
  #1
}

% Employment/Research Experience Entry
% Usage: \employment{institution}{location}{dates}{role}{description}{achievements}
% achievements can be empty or contain \item entries
\newcommand{\employment}[6]{%
  \@entry*[]%
  \textbf{#1}, #2 \hfill #3
  \par \textit{#4}
  \par \raggedright #5
  \@cvifempty{#6}{}{\begin{itemize}#6\end{itemize}}%
}

% Teaching Experience Entry
% Usage: \teachingexp{institution}{location}{dates}{role}{description}{achievements}
\newcommand{\teachingexp}[6]{%
  \@entry*[]%
  \textbf{#1}, #2 \hfill #3
  \par \textit{#4}
  \par \raggedright #5
  \@cvifempty{#6}{}{\begin{itemize}#6\end{itemize}}%
}

% Industrial Experience Entry
% Usage: \industrial{company}{location}{dates}{role}{description}{achievements}
% Format: First row - **Company**, Location + Date (right-aligned)
%         Second row - Position Title (italics)
%         Third row - Description
%         Fourth - Achievements (optional, use \item entries)
% achievements can be empty or contain \item entries
\newcommand{\industrial}[6]{%
  \@entry*[]%
  \textbf{#1}, #2 \hfill #3
  \par \textit{#4}
  \par \raggedright #5
  \@cvifempty{#6}{}{\begin{itemize}#6\end{itemize}}%
}

% Education Entry
% Usage: \education{degree}{university}{location}{dates}{additional}
% Format: First row - Degree + Date (right-aligned)
%         Second row - University, Country
%         Third row - Additional info (optional)
% additional can be empty
\newcommand{\education}[5]{%
  \@entry*[]%
  \textbf{#1} \hfill #4
  \par #2, #3
  \@cvifempty{#5}{}{\par \raggedright #5}%
}

% Additional Training Entry
% Usage: \training{name}{location}{dates}{additional}
% Format: First row - **Training Name** + Date (right-aligned)
%         Second row - Location
%         Third row - Additional info (optional)
% additional can be empty
\newcommand{\training}[4]{%
  \@entry*[]%
  \textbf{#1} \hfill #3
  \par \raggedright #2
  \@cvifempty{#4}{}{\par \raggedright #4}%
}

% Certification Entry
% Usage: \certification{name}{issuer}{dates}{additional}
% Format: First row - **Certification Name** + Date (right-aligned)
%         Second row - Issuing Organization/Platform
%         Third row - Additional info (optional)
% additional can be empty
\newcommand{\certification}[4]{%
  \@entry*[]%
  \textbf{#1} \hfill #3
  \par \raggedright #2
  \@cvifempty{#4}{}{\par \raggedright #4}%
}

% Professional Development Entry
% Usage: \professionaldev{activity}{location}{dates}{additional}
% Format: First row - **Activity Name** + Date (right-aligned)
%         Second row - Location/Institution
%         Third row - Additional info (optional)
% location and additional can be empty
\newcommand{\professionaldev}[4]{%
  \@entry*[]%
  \textbf{#1} \hfill #3
  \@cvifempty{#2}{}{\par \raggedright #2}%
  \@cvifempty{#4}{}{\par \raggedright #4}%
}

% Award/Honor Entry
% Usage: \award{name}{organization}{dates}{description}
% Format: First row - **Award Name** + Date (right-aligned)
%         Second row - Organization/Location (optional)
%         Third row - Description/Additional info (optional)
% organization and description can be empty
\newcommand{\award}[4]{%
  \@entry*[]%
  \textbf{#1} \hfill #3
  \@cvifempty{#2}{}{\par \raggedright #2}%
  \@cvifempty{#4}{}{\par \raggedright #4}%
}

% Presentation Entry
% Usage: \presentation{title}{venue}{location}{dates}{additional}
% Format: First row - **Title** + Date (right-aligned)
%         Second row - Venue, Location
%         Third row - Additional info (optional)
% additional can be empty
\newcommand{\presentation}[5]{%
  \@entry*[]%
  \textbf{#1} \hfill #4
  \par \textit{#2}, #3
  \@cvifempty{#5}{}{\par \raggedright #5}%
}

% Invited Talk/Interview Entry
% Usage: \invitedtalk{title}{event}{dates}{additional}
% Format: First row - **Title** + Date (right-aligned)
%         Second row - Event Name
%         Third row - Additional info (optional)
% additional can be empty
\newcommand{\invitedtalk}[4]{%
  \@entry*[]%
  \textbf{#1} \hfill #3
  \par \textit{#2}
  \@cvifempty{#4}{}{\par \raggedright #4}%
}

% Research Grant Entry
% Usage: \grant{title}{agency}{role}{status}{dates}
% status can be empty
\newcommand{\grant}[5]{%
  \@entry*[] \textbf{#1}
  \begin{itemize}
    \item \textbf{Funding agency:} #2
    \item \textbf{Role:} #3
    \@cvifempty{#4}{}{\item \textbf{Status:} #4}%
    \@cvifempty{#5}{}{\item \textbf{Dates:} #5}%
  \end{itemize}
}

% Research Project Entry
% Usage: \researchproject{title}{status}
% status can be empty or "Active" or "Completed"
\newcommand{\researchproject}[2]{%
  \@entry*[] \textbf{#1}%
  \@cvifempty{#2}{}{ (#2)}%
}

% Supervision Entry
% Usage: \supervision{student}{project}{type}{level}{year}{status}
% Format: First row - **Student Name** + Year (right-aligned)
%         Second row - Project/Thesis Title
%         Third row - Type | Level | Status (only shows non-empty fields)
% type: Research, Thesis, etc. (can be empty {})
% level: Bachelor's, Master's, PhD, etc. (can be empty {})
% status: Completed, In Progress, etc. (can be empty {})
% \newcommand{\supervision}[6]{%
%   \@entry*[]%
%   \textbf{#1} \hfill #5
%   \par \textit{#2}%
%   \@cvifempty{#3}{}{%
%     \@cvifempty{#4}{}{%
%       \@cvifempty{#6}{}{\par #3 | #4 Level | #6}%
%       \@cvifempty{#6}{}{\par #3 | #4 Level}%
%     }%
%     \@cvifempty{#4}{}{%
%       \@cvifempty{#6}{}{\par #3 | #6}%
%       \@cvifempty{#6}{}{\par #3}%
%     }%
%   }%
%   \@cvifempty{#3}{}{%
%     \@cvifempty{#4}{}{%
%       \@cvifempty{#6}{}{\par #4 Level | #6}%
%       \@cvifempty{#6}{}{\par #4 Level}%
%     }%
%     \@cvifempty{#4}{}{%
%       \@cvifempty{#6}{}{\par #6}%
%     }%
%   }%
% }
% Supervision Entry
% Usage: \supervision{student}{project}{type}{level}{year}{status}
% Format: First row  - Student Name .......... Year (right-aligned)
%         Second row - Project/Thesis Title (italic)
%         Third row  - Type | Level Level | Status  (only non-empty parts)

% \newcommand{\supervision}[6]{%
%   \@entry*[]%
%   \textbf{#1} \hfill #5%
%   \par \textit{#2}%
%   %
%   % Build the "Type | Level Level | Status" line
%   \begingroup
%     \def\superline{}%
%     % Type
%     \@cvifempty{#3}{}{\edef\superline{#3}}%
%     % Level
%     \@cvifempty{#4}{}{%
%       \ifx\superline\@cv@empty
%         \edef\superline{#4\space Level}%
%       \else
%         \edef\superline{\superline\space|\space #4\space Level}%
%       \fi
%     }%
%     % Status
%     \@cvifempty{#6}{}{%
%       \ifx\superline\@cv@empty
%         \edef\superline{#6}%
%       \else
%         \edef\superline{\superline\space|\space #6}%
%       \fi
%     }%
%     % Print line only if something is non-empty
%     \@cvifempty{\superline}{}{\par \superline}%
%   \endgroup
% }


% Supervision Entry
% Usage: \supervision{student}{project}{type}{level}{year}{status}{institute}
% Format:
%   Student Name(s) ................. Year
%   Project / Thesis Title (italic)
%   Institute / University (optional)
%   Type | Level Level | Status  (auto-skips empty parts)

% Supervision Entry
% Usage: \supervision{student}{project}{type}{level}{year}{status}{affiliation}

\newcommand{\supervision}[7]{%
  \@entry*[]%
  \textbf{#1} \hfill #5%
  \par \textit{#2}%
  %
  % Affiliation line (optional)
  \@cvifempty{#7}{}{%
    \par \textit{Student Affiliation:} #7%
  }%
  %
  % Build Type | Level | Status line
  \begingroup
    \def\@supline{\@cv@empty}%
    % type
    \@cvifempty{#3}{}{\edef\@supline{#3}}%
    % level
    \@cvifempty{#4}{}{%
      \ifx\@supline\@cv@empty
         \edef\@supline{#4\space Level}%
      \else
         \edef\@supline{\@supline\space|\space #4\space Level}%
      \fi
    }%
    % status
    \@cvifempty{#6}{}{%
      \ifx\@supline\@cv@empty
         \edef\@supline{#6}%
      \else
         \edef\@supline{\@supline\space|\space #6}%
      \fi
    }%
    % print it
    \ifx\@supline\@cv@empty\else
      \par \@supline
    \fi
  \endgroup
}



% Entrepreneurship Entry
% Usage: \entrepreneurship{name}{description}{role}{focus}{website}
% focus and website can be empty
\newcommand{\entrepreneurship}[5]{%
  \@entry*[] \textbf{#1}: #2
  \begin{itemize}
    \item \textbf{Role}: #3
    \@cvifempty{#4}{}{\item \textbf{Focus}: #4}%
    \@cvifempty{#5}{}{\item \textbf{Website}: \href{#5}{#5}}%
  \end{itemize}
}

% Service Entry (Reviewer, Committee, etc.)
% Usage: \service{role}{venue}{dates}{additional}
% Format: First row - **Role** + Date (right-aligned)
%         Second row - Venue/Journal/Conference Name
%         Third row - Additional info (optional)
% additional can be empty
\newcommand{\service}[4]{%
  \@entry*[]%
  \textbf{#1} \hfill #3
  \par \textit{#2}
  \@cvifempty{#4}{}{\par \raggedright #4}%
}

% Service Role Group - Groups services by role with bulleted venue list
% Usage: \servicerole{role} ... \servicevenue{venue}{date} ... \endservicerole
% Format: Role name (indented, not bold)
%         Bulleted list of venues with dates (indented further, with dots)
\newcommand{\servicerole}[1]{%
  \@entry*[]%
  \hspace{1em}#1%
}

% Service Venue Entry - Adds a venue to the current role group
% Usage: \servicevenue{venue}{date}
% Format: Bullet point with venue name and date (right-aligned)
\newcommand{\servicevenue}[2]{%
  \@entry*[]%
  \hspace{2em}\textbullet\ #1 \hfill #2
}

% Skill Category Entry
% Usage: \skillcategory{category}{skills}
% skills should be comma-separated
\newcommand{\skillcategory}[2]{%
  \@entry*[] \textbf{#1}: #2
}

% Volunteer Entry
% Usage: \volunteer{role}{organization}{dates}{additional}
% Format: First row - **Role** + Date (right-aligned)
%         Second row - Organization Name
%         Third row - Additional info (optional)
% additional can be empty
\newcommand{\volunteer}[4]{%
  \@entry*[]%
  \textbf{#1} \hfill #3
  \par \raggedright #2
  \@cvifempty{#4}{}{\par \raggedright #4}%
}

% Reference Entry
% Usage: \reference{name}{title}{institution}{email}
\newcommand{\reference}[4]{%
  \@entry*[] \textbf{#1}, #2, #3, \texttt{#4}
}

% Open Source Project Entry
% Usage: \opensource{name}{project}{url}
% project and url can be empty
\newcommand{\opensource}[3]{%
  \@entry*[] #1
  \begin{itemize}
    \@cvifempty{#2}{}{\item Project: \href{#2}{#2}}%
    \@cvifempty{#3}{}{\item URL: \url{#3}}%
  \end{itemize}
}

% Workshop/Event Organization Entry
% Usage: \workshoporg{title}{location}{dates}{organization}{host}{registrations}{participants}{additional}
% Format: First row - **Title** + Date (right-aligned)
%         Second row - Location/Venue
%         Third row - Organization, Host, Registrations, Participants, and additional info
% Most fields can be empty - use {} for optional fields
\newcommand{\workshoporg}[8]{%
  \@entry*[]%
  \textbf{#1} \hfill #3
  \par #2
  \@cvifempty{#4}{}{%
    \@cvifempty{#5}{}{%
      \@cvifempty{#6}{}{%
        \@cvifempty{#7}{}{%
          \par Organized through \textit{#4}%
          \@cvifempty{#5}{}{, hosted by \textit{#5}}%
          \@cvifempty{#6}{}{, attracting \textbf{#6+ registrations}}%
          \@cvifempty{#7}{}{ and engaging \textbf{#7+ active participants}}%
        }%
      }%
    }%
  }%
  \@cvifempty{#8}{}{\par \raggedright #8}%
}

% Editorial Service Entry
% Usage: \editorial{role}{venue}{url}{year}{additional}
% Format: First row - **Role** + Date (right-aligned)
%         Second row - Venue/Journal/Conference Name
%         Third row - URL (if provided) and additional info (optional)
% url and additional can be empty
\newcommand{\editorial}[5]{%
  \@entry*[]%
  \textbf{#1} \hfill #4
  \par \textit{#2}%
  \@cvifempty{#3}{}{%
    \@cvifempty{#5}{}{\par \raggedright \url{#3}}%
    \@cvifempty{#5}{}{\par \raggedright \url{#3}. #5}%
  }%
  \@cvifempty{#3}{}{%
    \@cvifempty{#5}{}{\par \raggedright #5}%
  }%
}

% Course Entry
% Usage: \course{code}{name}{semesters}{additional}
% Format: First row - **Course Code Course Name** + Semesters (right-aligned, if provided)
%         Second row - Additional info (optional)
% semesters and additional can be empty
% Note: Institution and location should be specified in \subcvsection{} to avoid repetition
\newcommand{\course}[4]{%
  \@entry*[]%
  \textbf{#1 #2}%
  \@cvifempty{#3}{}{\ \hfill #3}%
  \@cvifempty{#4}{}{\par \raggedright #4}%
}

% Last Updated Date
% Automatically displays the compilation date in the footer
% Optionally uses datetime2 package for better date formatting
\@ifpackageloaded{datetime2}{%
  \DTMlangsetup[en-US]{ordinal=raise}%
  \newcommand{\lastupdateddate}{\DTMtoday}%
}{%
  % Try to load datetime2, but fall back to \today if not available
  \IfFileExists{datetime2.sty}{%
    \RequirePackage[us]{datetime2}%
    \DTMlangsetup[en-US]{ordinal=raise}%
    \newcommand{\lastupdateddate}{\DTMtoday}%
  }{%
    \newcommand{\lastupdateddate}{\today}%
  }%
}

% Set up footer with last updated date (automatic - no command needed)
% This will automatically appear on every page
\AtBeginDocument{%
  \pagestyle{fancy}%
  \fancyhf{} % Clear all headers and footers
  \renewcommand{\headrulewidth}{0pt} % Remove header rule
  \renewcommand{\footrulewidth}{0pt} % Remove footer rule
  \fancyfoot[C]{%
    \small\textcolor{MarkerColour!70!black}{Last Updated: \lastupdateddate}%
  }%
}

